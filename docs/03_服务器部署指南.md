# 服务器部署指南 (生产环境)

本文档将指导您如何将"钓鱼邮件识别教学游戏"项目部署到一台全新的 Linux 服务器上，使其能够在公网被访问。

**部署目标**：
- 后端使用 `Gunicorn` 和 `Uvicorn` 运行，并通过 `Systemd` 管理，实现稳定运行和开机自启。
- 前端构建为静态文件。
- 使用 `Nginx` 作为反向代理，统一处理外部请求，并将 API 请求转发给后端。

**服务器要求**：
- 一台拥有公网 IP 的云服务器。
- 操作系统：Ubuntu 20.04 / 22.04 (本文档以此为例)。
- 拥有 `root` 或 `sudo` 权限。

---

## 1. 核心理念：为何比本地部署复杂？

在本地，我们用 `uvicorn --reload` 和 `npm run serve`，它们方便调试但性能和稳定性不足，不适合在服务器上长期运行。生产环境需要更专业的工具：

-   **Gunicorn**: 一个专业的 Python 应用服务器，能管理多个后端进程，提高并发处理能力和稳定性。
-   **Nginx**: 一个高性能的 Web 服务器和反向代理。它是网站的"门卫"，负责接收所有用户的访问请求。
    -   如果请求的是前端页面 (HTML/CSS/JS)，Nginx 直接把 `frontend/dist` 里的文件发给用户。
    -   如果请求的是后端 API (如 `/api/...`)，Nginx 会把这个请求转发给在后台运行的 Gunicorn 处理。
-   **Systemd**: Linux 系统自带的进程管理器。我们用它来"守护" Gunicorn 进程，确保它能开机自启，如果意外崩溃了也能自动重启。

---

## 2. 部署步骤

### 步骤一：服务器基础环境配置

通过 SSH 登录您的服务器，然后执行以下命令安装所有必要的软件。

```bash
# 1. 更新系统软件包列表
sudo apt update && sudo apt upgrade -y

# 2. 安装 Nginx, Python3, pip, venv 和 Git
sudo apt install nginx python3-pip python3-venv git -y

# 3. 安装 Node.js 和 npm
sudo apt install nodejs npm -y
```

### 步骤二：部署后端服务

1.  **获取代码**
    ```bash
    git clone <项目的Git仓库地址>
    cd game/backend
    ```

2.  **创建虚拟环境并安装依赖**
    ```bash
    python3 -m venv venv
    source venv/bin/activate
    pip install -r requirements.txt
    
    # 额外安装 gunicorn 用于生产环境
    pip install gunicorn
    ```
    *此时，您应该在 `(venv)` 虚拟环境下。*

3.  **配置 Systemd 服务文件**
    这是让后端服务稳定运行的关键一步。
    ```bash
    # 使用 nano 编辑器创建一个新的服务配置文件
    sudo nano /etc/systemd/system/game-backend.service
    ```
    将以下内容**完整地**粘贴到编辑器中。
    **注意：** 您必须将下面的 `/path/to/your/game/backend` 替换为您服务器上 `backend` 目录的**绝对路径**！(您可以通过 `pwd` 命令查看当前路径)

    ```ini
    [Unit]
    Description=Gunicorn instance for Phishing Game Backend
    After=network.target

    [Service]
    User=www-data
    Group=www-data
    WorkingDirectory=/path/to/your/game/backend
    ExecStart=/path/to/your/game/backend/venv/bin/gunicorn -w 4 -k uvicorn.workers.UvicornWorker app.main:app -b 127.0.0.1:8000
    Restart=always

    [Install]
    WantedBy=multi-user.target
    ```
    -   粘贴完毕后，按 `Ctrl+X`，然后按 `Y`，最后按 `Enter` 保存并退出。
    -   `-b 127.0.0.1:8000` 表示 Gunicorn 只监听来自服务器内部的请求，这是更安全的做法，因为所有外部请求都应由 Nginx 处理。

4.  **启动后端服务**
    ```bash
    # 重新加载 systemd 配置
    sudo systemctl daemon-reload

    # 启动我们刚创建的服务
    sudo systemctl start game-backend

    # 将服务设置为开机自启
    sudo systemctl enable game-backend

    # 查看服务状态，确保它是 "active (running)"
    sudo systemctl status game-backend
    ```
    *如果状态不是 running，请检查 `.service` 文件中的路径是否正确。按 `q` 退出状态查看。*

### 步骤三：部署前端应用

1.  **构建前端静态文件**
    首先，回到 `game` 根目录，然后进入 `frontend`。
    ```bash
    cd ../frontend
    npm install
    npm run build
    ```
    此命令会执行打包操作，并在 `frontend` 目录下生成一个 `dist` 文件夹。这个文件夹里包含了所有优化、压缩过的前端静态文件，是我们要部署的最终产物。

### 步骤四：配置 Nginx (最后的"门卫")

1.  **创建 Nginx 配置文件**
    ```bash
    sudo nano /etc/nginx/sites-available/game
    ```
    将以下配置粘贴进去。
    **注意：** 您必须修改以下两个地方：
    -   `server_name your_domain.com;` -> 替换为您的**服务器域名或公网IP地址**。
    -   `root /path/to/your/game/frontend/dist;` -> 替换为前端 `dist` 目录的**绝对路径**。

    ```nginx
    server {
        listen 80;
        server_name your_domain.com;

        # 1. 前端静态文件服务配置
        # root 指向前端打包后的 dist 目录
        root /path/to/your/game/frontend/dist;
        index index.html;

        location / {
            # 这一行是处理 Vue Router history 模式的关键，确保刷新页面不报 404
            try_files $uri $uri/ /index.html;
        }

        # 2. 后端 API 反向代理配置
        # 将所有 /api/ 开头的请求，都转发给在 8000 端口运行的后端服务
        location /api {
            proxy_pass http://127.0.0.1:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
    ```
    同样，使用 `Ctrl+X`, `Y`, `Enter` 保存退出。

2.  **启用 Nginx 配置**
    ```bash
    # 在 sites-enabled 目录创建一个指向我们配置文件的"快捷方式"
    sudo ln -s /etc/nginx/sites-available/game /etc/nginx/sites-enabled/

    # 测试 Nginx 配置语法是否有错误
    sudo nginx -t
    # 如果看到 "syntax is ok" 和 "test is successful" 就代表没问题

    # 重启 Nginx 使配置生效
    sudo systemctl restart nginx
    ```

3.  **(可选，但推荐) 配置防火墙**
    如果您的服务器开启了防火墙 (UFW)，需要允许 Nginx 的流量通过。
    ```bash
    sudo ufw allow 'Nginx Full'
    sudo ufw reload
    ```

## 3. 部署完成！

恭喜！现在，打开浏览器，访问您的服务器域名或公网 IP 地址，您的"钓鱼邮件识别教学游戏"就已经成功部署在服务器上了！ 